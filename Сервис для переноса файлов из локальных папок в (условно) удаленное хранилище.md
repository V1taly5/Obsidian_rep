#### Общая идея

Сервис предназначен для переноса файлов из локальных папок в удаленное хранилище. Он отслеживает изменения в заданной директории и автоматически синхронизирует новые файлы с удаленным хранилищем.

#### Функциональные требования

##### Отслеживание папки

- Папка для отслеживания указывается при запуске сервиса либо в конфигурационном файле, допускается комбинирование этих методов.
- Отслеживаются все вложенные папки внутри указанной папки.
- Возможность исключения определенных подкаталогов или типов файлов из отслеживания.

##### Перенос файла

- Файл сохраняется в одну из отслеживаемых папок.
- Происходит индексирование новых файлов.
- Новые файлы переносятся в удаленное хранилище.
- Проверка успешности переноса и повторные попытки в случае неудачи.
- Удаление локальных файлов после успешного переноса (опционально).

#### Последовательность действий

1. Новый файл добавляется в отслеживаемую папку.
2. Выполняется команда для индексирования новых файлов.
3. По команде происходит односторонняя синхронизация папки и удаленного хранилища (все новые файлы отправляются в удаленное хранилище).

#### Нефункциональные требования

- Высокая производительность и надежность при отслеживании и переносе файлов.
- Обработка ошибок и уведомление о сбоях.
- Логирование всех операций и событий.
- Конфигурируемые таймауты и интервалы повторных попыток.

#### Архитектура

##### Компоненты системы

1. **Конфигурационный модуль**
    
    - Чтение параметров конфигурации из файла или командной строки.
    - Параметры включают:
        - Путь к отслеживаемой папке.
        - Параметры подключения к удаленному хранилищу.
        - Исключаемые подкаталоги и типы файлов.
        - Таймауты и интервалы повторных попыток.
2. **Модуль отслеживания изменений файловой системы**
    
    - Использование пакета `fsnotify` для отслеживания изменений в файловой системе.
    - Рекурсивное добавление подкаталогов для отслеживания.
3. **Модуль индексирования файлов**
    
    - Индексация новых файлов, добавленных в отслеживаемую папку.
    - Хранение информации о новых файлах в памяти или временной базе данных.
4. **Модуль синхронизации с удаленным хранилищем**
    
    - Передача новых файлов в удаленное хранилище.
    - Удаленное хранилище условно может быть представлено как локальный каталог для тестирования.
5. **Модуль логирования и уведомлений**
    
    - Логирование всех операций и событий.
    - Уведомления о сбоях и ошибках через e-mail или другие каналы.

```GO
package main

import (
    "fmt"
    "log"
    "os"
    "path/filepath"
    "github.com/fsnotify/fsnotify"
)

// Конфигурация сервиса
type Config struct {
    WatchDir       string
    RemoteDir      string
    ExcludeDirs    []string
    ExcludeExts    []string
    RetryInterval  int
    Timeout        int
    NotifyEmail    string
}

func main() {
    config := loadConfig()
    watcher, err := fsnotify.NewWatcher()
    if err != nil {
        log.Fatal(err)
    }
    defer watcher.Close()

    indexedFiles := make(map[string]bool)
    done := make(chan bool)

    go func() {
        for {
            select {
            case event, ok := <-watcher.Events:
                if !ok {
                    return
                }
                if event.Op&fsnotify.Create == fsnotify.Create {
                    if shouldIndex(event.Name, config) {
                        fmt.Println("New file created:", event.Name)
                        indexedFiles[event.Name] = true
                    }
                }
            case err, ok := <-watcher.Errors:
                if !ok {
                    return
                }
                log.Println("Error:", err)
            }
        }
    }()

    // Рекурсивное добавление подкаталогов
    err = filepath.Walk(config.WatchDir, func(path string, info os.FileInfo, err error) error {
        if err != nil {
            return err
        }
        if info.IsDir() && !isExcludedDir(path, config) {
            return watcher.Add(path)
        }
        return nil
    })
    if err != nil {
        log.Fatal(err)
    }

    // Запуск индексирования и синхронизации
    go indexAndSync(indexedFiles, config)

    <-done
}

func loadConfig() Config {
    // Загружаем конфигурацию из файла или параметров командной строки
    // Возвращаем объект Config
}

func shouldIndex(filePath string, config Config) bool {
    // Проверяем, нужно ли индексировать файл (исключаем по расширению)
    for _, ext := range config.ExcludeExts {
        if filepath.Ext(filePath) == ext {
            return false
        }
    }
    return true
}

func isExcludedDir(dirPath string, config Config) bool {
    // Проверяем, нужно ли исключить директорию из отслеживания
    for _, excludeDir := range config.ExcludeDirs {
        if dirPath == excludeDir {
            return true
        }
    }
    return false
}

func indexAndSync(indexedFiles map[string]bool, config Config) {
    for file := range indexedFiles {
        err := syncFile(file, config.RemoteDir)
        if err != nil {
            log.Println("Failed to sync file:", file, "Error:", err)
            // Повторные попытки переноса файла через config.RetryInterval
        } else {
            delete(indexedFiles, file)
        }
    }
}

func syncFile(filePath string, remoteDir string) error {
    // Логика переноса файла в удаленное хранилище
    return nil
}

```

### Дополнительные аспекты

- **Тестирование и отладка**:
    
    - Написание юнит-тестов для проверки различных компонентов системы.
    - Локальное тестирование с использованием имитируемого удаленного хранилища.
- **Уведомления**:
    
    - Настройка уведомлений для оповещения об ошибках и сбоях через email или другие каналы (например, Slack).
- **Оптимизация и производительность**:
    
    - Оптимизация рекурсивного обхода директории и обработки событий.
    - Обработка файлов в нескольких потоках для повышения производительности.
- **Безопасность**:
    
    - Обеспечение безопасного подключения к удаленному хранилищу.
    - Защита конфиденциальных данных в конфигурационных файлах (например, пароли, токены доступа).