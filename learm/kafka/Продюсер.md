Для записи событий в кластер Kafka есть продюсеры - это приложения, которые мы разрабатываем.
Программа-продюсер записывает сообщения  в Kafka, тот в свою очередь сохраняет события, возвращает подтверждение о записи или **_acknowledgement_**. Продюсер получает его и начинает следующую запись. 

## TLDR

Продюсеры самостоятельно партицируют данные в топиках и сами определяют алгоритм партицирования: он может быть как банальный **_round-robin_** и **_hash-based_**, так и кастомный. Важно помнить, что очерёдность сообщений гарантируется только для одной партиции.

Продюсер сам выбирает размер батча и число ретраев при отправке сообщений. Протокол Kafka предоставляет гарантии доставки всех трёх семантик: **_at-most once_**, **at-least once** и **_exactly-once_**.

У exactly once есть цена. Для надёжной записи вам необходимо использовать подтверждение как от лидера, так и от реплик, включить идемпотентность и использовать транзакционный API. Всё это негативно влияет на время записи.

Не забывайте, что сломаться в пути может что угодно: например, просесть сеть или сломаться сам брокер. Переходящие процессы в кластере, как выбор лидера, редкость, но это случается, и клиенты должны уметь их грамотно обрабатывать.

Если вы хотите писать в Kafka надёжно, указывайте при создании топика **_min.insync.replicas_** меньше, чем общее количество реплик. В противном случае, лишившись брокера в случай аварии вы рискуете вовсе ничего не записать, т.к. не дождётесь подтверждения записи.

Если вы указываете **_acks=all_**, то включайте и **_enable.idempotence_**. Накладных расходов на идемпотентность нет.